<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments :: head('Festival detail')}"></head>
<body class="bg-gray-50">
	<div th:replace="~{fragments :: navbar}"></div>
	<div th:replace="~{fragments :: flash}"></div>

	<main class="container mx-auto px-4 py-8">
		<section class="bg-white rounded-xl shadow p-6">
			<div class="flex items-start justify-between gap-6">
				<div>
					<h1 class="text-2xl font-semibold" th:text="${festival.name}">Naam</h1>
					<p class="text-gray-600 mt-1">
						<span
							th:text="${#temporals.format(festival.startDateTime, 'dd/MM/yyyy HH:mm')}">datum</span>
						• <span
							th:text="${festival.location != null ? festival.location.name : 'n.v.t.'}">locatie</span>
						• <span
							th:text="${festival.category != null ? festival.category.name : 'n.v.t.'}">cat</span>
					</p>
					<p class="mt-2">
						Gemiddelde score: <span class="font-medium"
							th:text="${#numbers.formatDecimal(averageRating, 1, 'COMMA', 1, 'POINT')}">0.0</span>
						/ 5
					</p>
					<p class="mt-1">
						Prijs: € <span th:text="|€ ${#numbers.formatDecimal(festival.ticketPrice, 1, 2)}|">0,00</span>

					</p>
					<p class="mt-1">
						Tickets: <span class="font-medium" th:text="${remainingTickets}">0</span>
						beschikbaar <span class="text-gray-500"
							th:if="${userTicketsBought != null}"> • Jij kocht: <span
							th:text="${userTicketsBought}">0</span>
						</span>
					</p>
				</div>
				<div class="text-right" sec:authorize="hasRole('ADMIN')">
					<a th:href="@{|/admin/festivals/${festival.festivalId}/edit|}"
						class="px-3 py-1 rounded border">Bewerken</a>
				</div>
			</div>
		</section>

		<!-- Standhouders -->
		<section class="mt-6 bg-white rounded-xl shadow p-6">
			<h2 class="text-lg font-semibold mb-3">Standhouders</h2>
			<ul class="list-disc ml-5"
				th:if="${!#lists.isEmpty(festival.standhouders)}">
				<li th:each="s : ${festival.standhouders}" th:text="${s.name}">Standhouder</li>
			</ul>
			<p class="text-gray-500"
				th:if="${#lists.isEmpty(festival.standhouders)}">Nog geen
				standhouders gekoppeld.</p>
		</section>

		<!-- Tickets kopen -->
		<div sec:authorize="hasRole('USER')">

			<section class="mt-6 bg-white rounded-xl shadow p-6">
				<h2 class="text-lg font-semibold mb-3">Koop tickets</h2>
				<div th:if="${remainingTickets > 0}">

					<form th:action="@{|/tickets/buy/${festival.festivalId}|}"
						method="post" class="flex items-end gap-3">
						<input type="hidden" th:name="${_csrf.parameterName}"
							th:value="${_csrf.token}">
						<div>
							<label class="block text-sm text-gray-600 mb-1">Aantal</label> <input
								name="quantity" type="number" min="1" step="1"
								class="border rounded p-2 w-28" value="1">
						</div>
						<button class="px-4 py-2 rounded bg-black text-white">Kopen</button>
					</form>

				</div>
				<p class="text-red-600" th:if="${remainingTickets <= 0}">Uitverkocht.</p>
			</section>
		</div>

		<!-- Reviews -->
		<div class="flex gap-2"
     xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
  <a class="px-3 py-2 rounded border"
     sec:authorize="hasRole('USER')"
     th:href="@{|/festivals/${festival.festivalId}/reviews|}">
    Reviews
  </a>

  <!-- Alleen tonen als controller canWriteReview=true zet -->
  <a class="px-3 py-2 rounded bg-black text-white"
     sec:authorize="hasRole('USER')"
     th:if="${canWriteReview}"
     th:href="@{|/festivals/${festival.festivalId}/reviews/new|}">
    Schrijf review
  </a>
</div>

<!-- OPTIONEEL: COMPACT OVERZICHT -->
<section class="mt-6" th:if="${avgRating != null}">
  <div class="p-4 bg-white rounded-xl shadow mb-3">
    Gemiddelde score:
    <b th:text="${#numbers.formatDecimal(avgRating,1,1)}">0.0</b> / 5
    <a class="ml-3 underline"
       th:href="@{|/festivals/${festival.festivalId}/reviews|}">bekijk alle reviews</a>
  </div>

  <ul class="space-y-3" th:if="${#lists.size(reviews) > 0}">
    <li th:each="r,iter : ${reviews}" th:if="${iter.index < 3}"
        class="p-4 bg-white rounded-xl shadow">
      <div>Score: <b th:text="${r.rating}">5</b> / 5</div>
      <div class="text-gray-700" th:text="${r.description}">Comment</div>
      <div class="text-xs text-gray-500"
           th:if="${r.createdAt != null}"
           th:text="${#temporals.format(r.createdAt,'dd/MM/yyyy HH:mm')}">datum</div>
    </li>
  </ul>
</section>

	</main>

	<div th:replace="~{fragments :: footer}"></div>
</body>
</html>
