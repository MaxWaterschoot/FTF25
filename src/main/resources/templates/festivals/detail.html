<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments :: head('Festival detail')}"></head>
<body class="bg-gray-50">
  <div th:replace="~{fragments :: navbar}"></div>
  <div th:replace="~{fragments :: flash}"></div>

  <main class="container mx-auto px-4 py-8">
    <section class="bg-white rounded-xl shadow p-6">
      <div class="flex items-start justify-between gap-6">
        <div>
          <h1 class="text-2xl font-semibold" th:text="${festival.name}">Naam</h1>
          <p class="text-gray-600 mt-1">
            <span th:text="${#temporals.format(festival.startDateTime, 'dd/MM/yyyy HH:mm')}">datum</span>
            • <span th:text="${festival.location != null ? festival.location.name : 'n.v.t.'}">locatie</span>
            • <span th:text="${festival.category != null ? festival.category.name : 'n.v.t.'}">cat</span>
          </p>
          <p class="mt-2">Gemiddelde score: 
            <span class="font-medium" th:text="${#numbers.formatDecimal(averageRating, 1, 'COMMA', 1, 'POINT')}">0.0</span> / 5
          </p>
          <p class="mt-1">Prijs: € <span th:text="${festival.ticketPrice}">0.00</span></p>
          <p class="mt-1">
            Tickets: <span class="font-medium" th:text="${remainingTickets}">0</span> beschikbaar
            <span class="text-gray-500" th:if="${userTicketsBought != null}">
              • Jij kocht: <span th:text="${userTicketsBought}">0</span>
            </span>
          </p>
        </div>
        <div class="text-right" sec:authorize="hasRole('ADMIN')">
          <a th:href="@{|/admin/festivals/${festival.festivalId}/edit|}" class="px-3 py-1 rounded border">Bewerken</a>
        </div>
      </div>
    </section>

    <!-- Standhouders -->
    <section class="mt-6 bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-semibold mb-3">Standhouders</h2>
      <ul class="list-disc ml-5" th:if="${!#lists.isEmpty(festival.standhouders)}">
        <li th:each="s : ${festival.standhouders}" th:text="${s.name}">Standhouder</li>
      </ul>
      <p class="text-gray-500" th:if="${#lists.isEmpty(festival.standhouders)}">Nog geen standhouders gekoppeld.</p>
    </section>

    <!-- Tickets kopen -->
    <section class="mt-6 bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-semibold mb-3">Koop tickets</h2>
      <div th:if="${remainingTickets > 0}">
      <div sec:authorize="hasRole('USER')">
      
        <form th:action="@{|/tickets/buy/${festival.festivalId}|}" method="post" class="flex items-end gap-3">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Aantal</label>
            <input name="quantity" type="number" min="1" step="1" class="border rounded p-2 w-28" value="1">
          </div>
          <button class="px-4 py-2 rounded bg-black text-white">Kopen</button>
        </form>
        </div>
      </div>
      <p class="text-red-600" th:if="${remainingTickets <= 0}">Uitverkocht.</p>
    </section>

    <!-- Reviews -->
    <section class="mt-6 bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-semibold mb-4">Reviews</h2>

      <div th:if="${#authorization.expression('isAuthenticated()') and canReview}">
        <form th:action="@{/reviews}" method="post" class="grid md:grid-cols-4 gap-3 mb-6">
          <input type="hidden" name="festivalId" th:value="${festival.festivalId}">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Score (1-5)</label>
            <input name="rating" type="number" min="1" max="5" class="border rounded p-2 w-full" value="5">
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm text-gray-600 mb-1">Beschrijving</label>
            <input name="description" type="text" class="border rounded p-2 w-full" placeholder="Wat vond je ervan?">
          </div>
          <div class="md:col-span-4">
            <button class="px-4 py-2 rounded bg-black text-white">Review plaatsen</button>
          </div>
        </form>
      </div>
      <p class="text-gray-500 mb-4" th:if="${#lists.isEmpty(reviews)}">Nog geen reviews.</p>

      <ul class="space-y-3" th:if="${!#lists.isEmpty(reviews)}">
        <li th:each="r : ${reviews}" class="border rounded p-3">
          <div class="flex items-center justify-between">
            <strong th:text="${r.author.username}">user</strong>
            <span class="text-sm text-gray-500" th:text="${#temporals.format(r.createdAt,'dd/MM/yyyy HH:mm')}">datum</span>
          </div>
          <div class="mt-1">Score: <span class="font-medium" th:text="${r.rating}">5</span>/5</div>
          <p class="mt-1" th:text="${r.description}">Beschrijving</p>
        </li>
      </ul>
    </section>
  </main>

  <div th:replace="~{fragments :: footer}"></div>
</body>
</html>
